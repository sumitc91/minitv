name: Update Daily Feed

on:
  schedule:
    - cron: '0 0 * * *'  # Runs daily at midnight UTC
  workflow_dispatch:

jobs:
  update-feed:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v3

      - name: Set Date Variables
        run: |
          DATE=$(date +"%Y-%m-%d")
          POST_FILE="posts/$DATE.html"
          echo "Today's Post File: $POST_FILE"

      - name: Delete Existing Post (if exists)
        run: |
          if [ -f "$POST_FILE" ]; then
            echo "Post already exists. Deleting..."
            rm "$POST_FILE"
          else
            echo "No existing post found. Creating a new one."
          fi

      - name: Fetch News from Multiple Countries
        run: |
          DATE=$(date +"%Y-%m-%d")
          POST_FILE="posts/$DATE.html"
          mkdir -p posts

          echo "Fetching global news..."

          # Define country codes
          COUNTRIES=("us" "in" "gb" "ca" "au" "de" "fr" "jp")

          # Start HTML File
          echo '<!DOCTYPE html>
          <html lang="en">
          <head>
              <meta charset="UTF-8">
              <meta name="viewport" content="width=device-width, initial-scale=1.0">
              <meta name="description" content="Latest global news updates for '"$DATE"' with full details. Stay informed with top headlines.">
              <meta name="keywords" content="news, world news, global news, headlines, daily news, latest news">
              <meta name="author" content="MiniTV">
              <meta property="og:title" content="Daily News - '"$DATE"'">
              <meta property="og:description" content="Top news articles with full details for '"$DATE"'">
              <meta name="robots" content="index, follow">
              <title>Daily News - '"$DATE"'</title>
              <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css">
              <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
              <style>
                  body { font-family: Arial, sans-serif; background-color: #f8f9fa; }
                  .container { max-width: 900px; margin: auto; padding: 20px; background: #fff; border-radius: 8px; box-shadow: 0px 0px 10px rgba(0,0,0,0.1); }
                  h1 { text-align: center; margin-bottom: 20px; }
                  h3 { margin-top: 20px; color: #333; }
                  .news-card { border: 1px solid #ddd; padding: 15px; border-radius: 8px; margin-bottom: 15px; background: #fff; }
                  .news-title { font-size: 18px; font-weight: bold; }
                  .news-source { font-size: 14px; color: #555; }
                  .news-description { margin-top: 10px; font-size: 16px; }
                  .news-img { width: 100%; max-height: 300px; object-fit: cover; border-radius: 8px; margin-top: 10px; }
                  .ads-container { text-align: center; margin: 20px 0; }
              </style>
          </head>
          <body>
              <div class="container">
                  <h1>üåç Global News - '"$DATE"'</h1>
                  <p>Stay updated with the latest headlines from different countries, with full details and images.</p>' > $POST_FILE

          # Fetch Global News
          for COUNTRY in "${COUNTRIES[@]}"; do
            echo "Fetching news for $COUNTRY..."
            RESPONSE=$(curl -s "https://newsapi.org/v2/top-headlines?country=$COUNTRY&apiKey=${{ secrets.NEWSAPI_KEY }}")

            ARTICLES=$(echo "$RESPONSE" | jq -c '.articles[]')
            
            COUNTRY_NAME=$(echo "$COUNTRY" | tr '[:lower:]' '[:upper:]')
            echo "<h2>üåç Top News from $COUNTRY_NAME</h2>" >> $POST_FILE

            # Loop through each news article
            while IFS= read -r article; do
              TITLE=$(echo "$article" | jq -r '.title // "No title available"')
              SOURCE_NAME=$(echo "$article" | jq -r '.source.name // "Unknown Source"')
              AUTHOR=$(echo "$article" | jq -r '.author // "Unknown Author"')
              DESCRIPTION=$(echo "$article" | jq -r '.description // "No description available"')
              URL=$(echo "$article" | jq -r '.url // "#"')
              IMAGE=$(echo "$article" | jq -r '.urlToImage // "https://via.placeholder.com/800x400?text=No+Image"')
              PUBLISHED_DATE=$(echo "$article" | jq -r '.publishedAt // "Unknown Date"')

              echo "<div class='news-card'>
                        <h3 class='news-title'><a href='$URL' target='_blank'>$TITLE</a></h3>
                        <p class='news-source'>Source: $SOURCE_NAME | Author: $AUTHOR | Published: $PUBLISHED_DATE</p>
                        <img src='$IMAGE' class='news-img' alt='News Image'>
                        <p class='news-description'>$DESCRIPTION</p>
                    </div>" >> $POST_FILE
            done <<< "$ARTICLES"
          done

          echo '<div class="ads-container">
              <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
              <ins class="adsbygoogle"
                  style="display:block"
                  data-ad-client="YOUR_ADSENSE_CLIENT_ID"
                  data-ad-slot="YOUR_ADSENSE_AD_SLOT"
                  data-ad-format="auto"
                  data-full-width-responsive="true"></ins>
              <script>
                  (adsbygoogle = window.adsbygoogle || []).push({});
              </script>
          </div>
          </div>
          </body>
          </html>' >> $POST_FILE

      - name: Commit and Push Changes
        run: |
          git config --global user.name "github-actions"
          git config --global user.email "github-actions@github.com"
          git add posts/
          git commit -m "Automated full news update for $(date +"%Y-%m-%d")" || echo "No changes to commit"
          git push https://x-access-token:${{ secrets.GITHUB_TOKEN }}@github.com/sumitc91/minitv.git main || echo "No changes to push"
