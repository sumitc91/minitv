name: Update Daily Feed

on:
  schedule:
    - cron: '0 0 * * *'  # Runs daily at midnight UTC
  workflow_dispatch:

jobs:
  update-feed:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v3

      - name: Set Date Variables
        run: |
          DATE=$(date +"%Y-%m-%d")
          POST_FILE="posts/$DATE.html"
          echo "Today's Post File: $POST_FILE"

      - name: Delete Existing Post (if exists)
        run: |
          if [ -f "$POST_FILE" ]; then
            echo "Post already exists. Deleting..."
            rm "$POST_FILE"
          else
            echo "No existing post found. Creating a new one."
          fi

      - name: Fetch Data from Multiple Sources
        run: |
          DATE=$(date +"%Y-%m-%d")
          POST_FILE="posts/$DATE.html"
          mkdir -p posts

          echo "Fetching news, Reddit trends, crypto prices, stock data, and Wikipedia articles..."

          # Define country codes for news
          COUNTRIES=("us" "in" "gb" "ca" "au" "de" "fr" "jp")

          echo '<!DOCTYPE html>
          <html lang="en">
          <head>
              <meta charset="UTF-8">
              <meta name="viewport" content="width=device-width, initial-scale=1.0">
              <meta name="description" content="Daily updates for '"$DATE"' including news, crypto, stocks, Reddit, and more.">
              <meta name="keywords" content="news, trending, crypto, Reddit, stocks, weather, Wikipedia">
              <meta name="author" content="MiniTV">
              <title>Daily Updates - '"$DATE"'</title>
              <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css">
              <style>
                  body { font-family: Arial, sans-serif; background-color: #f8f9fa; }
                  .container { max-width: 900px; margin: auto; padding: 20px; background: #fff; border-radius: 8px; box-shadow: 0px 0px 10px rgba(0,0,0,0.1); }
                  h1 { text-align: center; margin-bottom: 20px; }
                  h3 { margin-top: 20px; color: #333; }
                  .news-card { border: 1px solid #ddd; padding: 15px; border-radius: 8px; margin-bottom: 15px; background: #fff; }
                  .news-title { font-size: 18px; font-weight: bold; }
                  .news-source { font-size: 14px; color: #555; }
                  .news-description { margin-top: 10px; font-size: 16px; }
                  .news-img { width: 100%; max-height: 300px; object-fit: cover; border-radius: 8px; margin-top: 10px; }
              </style>
          </head>
          <body>
              <div class="container">
                  <h1>üöÄ Daily Updates - '"$DATE"'</h1>
                  <p>Get the latest news, stock prices, crypto updates, Reddit trends, and much more!</p>' > $POST_FILE

          # Fetch Global News
          for COUNTRY in "${COUNTRIES[@]}"; do
            RESPONSE=$(curl -s "https://newsapi.org/v2/top-headlines?country=$COUNTRY&apiKey=${{ secrets.NEWSAPI_KEY }}")

            ARTICLES=$(echo "$RESPONSE" | jq -c '.articles[]')

            COUNTRY_NAME=$(echo "$COUNTRY" | tr '[:lower:]' '[:upper:]')
            echo "<h2>üåç Top News from $COUNTRY_NAME</h2>" >> $POST_FILE

            while IFS= read -r article; do
              TITLE=$(echo "$article" | jq -r '.title // "No title available"')
              SOURCE_NAME=$(echo "$article" | jq -r '.source.name // "Unknown Source"')
              AUTHOR=$(echo "$article" | jq -r '.author // "Unknown Author"')
              DESCRIPTION=$(echo "$article" | jq -r '.description // "No description available"')
              IMAGE=$(echo "$article" | jq -r '.urlToImage // "https://via.placeholder.com/800x400?text=No+Image"')
              PUBLISHED_DATE=$(echo "$article" | jq -r '.publishedAt // "Unknown Date"')

              echo "<div class='news-card'>
                        <h3 class='news-title'>$TITLE</h3>
                        <p class='news-source'>Source: $SOURCE_NAME | Author: $AUTHOR | Published: $PUBLISHED_DATE</p>
                        <img src='$IMAGE' class='news-img' alt='News Image'>
                        <p class='news-description'>$DESCRIPTION</p>
                    </div>" >> $POST_FILE
            done <<< "$ARTICLES"
          done

          # Fetch Reddit Trending Topics
          echo "Fetching Reddit trends..."
          REDDIT=$(curl -s "https://www.reddit.com/r/worldnews/top.json?limit=10" | jq -r '.data.children[] | "<li>" + .data.title + "</li>"')
          echo "<h2>üî• Reddit Trending</h2><ul>$REDDIT</ul>" >> $POST_FILE

          # Fetch Crypto Prices
          echo "Fetching crypto prices..."
          CRYPTO=$(curl -s "https://api.coingecko.com/api/v3/simple/price?ids=bitcoin,ethereum&vs_currencies=usd")
          BTC_PRICE=$(echo "$CRYPTO" | jq -r '.bitcoin.usd')
          ETH_PRICE=$(echo "$CRYPTO" | jq -r '.ethereum.usd')
          echo "<h2>üí∞ Cryptocurrency Prices</h2>" >> $POST_FILE
          echo "<p>Bitcoin: $$BTC_PRICE, Ethereum: $$ETH_PRICE</p>" >> $POST_FILE

          # Fetch Stock Market Prices
          echo "Fetching stock market data..."
          STOCKS=$(curl -s "https://financialmodelingprep.com/api/v3/quote/AAPL,GOOG,AMZN,MSFT?apikey=${{ secrets.STOCKS_API_KEY }}")
          echo "<h2>üìà Stock Market Prices</h2><ul>" >> $POST_FILE
          echo "$STOCKS" | jq -r '.[] | "<li>" + .name + " ($" + (.price | tostring) + ")</li>"' >> $POST_FILE
          echo "</ul>" >> $POST_FILE

          # Fetch Wikipedia Random Article
          echo "Fetching Wikipedia..."
          WIKI=$(curl -s "https://en.wikipedia.org/api/rest_v1/page/random/summary" | jq -r '"<h2>" + .title + "</h2><p>" + .extract + "</p>"')
          echo "<h2>üìö Wikipedia Random Article</h2>$WIKI" >> $POST_FILE

          echo "</div></body></html>" >> $POST_FILE

      - name: Commit and Push Changes
        run: |
          git config --global user.name "github-actions"
          git config --global user.email "github-actions@github.com"
          git add posts/
          git commit -m "Expanded content sources for $(date +"%Y-%m-%d")"
          git push https://x-access-token:${{ secrets.GITHUB_TOKEN }}@github.com/sumitc91/minitv.git main || echo "No changes to push"
