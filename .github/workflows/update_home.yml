name: Update Home Page

on:
  schedule:
    - cron: '0 1 * * *'  # Runs daily at 1:00 AM UTC
  workflow_dispatch:

jobs:
  update-home:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v3

      - name: Set File Variables
        run: |
          HOME_FILE="index.html"
          echo "Updating Home Page: $HOME_FILE"

      - name: Fetch Latest Stock & Crypto Prices
        run: |
          # Fetch Stock Market Prices
          STOCK_DATA=$(curl -s "https://financialmodelingprep.com/api/v3/quote/NDAQ,GSPC,DJI?apikey=${{ secrets.STOCKS_API_KEY }}")
          NASDAQ=$(echo "$STOCK_DATA" | jq -r '.[] | select(.symbol=="NDAQ") | .price')
          SP500=$(echo "$STOCK_DATA" | jq -r '.[] | select(.symbol=="GSPC") | .price')
          DOWJONES=$(echo "$STOCK_DATA" | jq -r '.[] | select(.symbol=="DJI") | .price')

          # Fetch Cryptocurrency Prices
          CRYPTO_DATA=$(curl -s "https://api.coingecko.com/api/v3/simple/price?ids=bitcoin,ethereum,dogecoin&vs_currencies=usd")
          BTC_PRICE=$(echo "$CRYPTO_DATA" | jq -r '.bitcoin.usd')
          ETH_PRICE=$(echo "$CRYPTO_DATA" | jq -r '.ethereum.usd')
          DOGE_PRICE=$(echo "$CRYPTO_DATA" | jq -r '.dogecoin.usd')

          # Save Variables for Use in Home Page
          echo "NASDAQ=$NASDAQ" >> $GITHUB_ENV
          echo "SP500=$SP500" >> $GITHUB_ENV
          echo "DOWJONES=$DOWJONES" >> $GITHUB_ENV
          echo "BTC_PRICE=$BTC_PRICE" >> $GITHUB_ENV
          echo "ETH_PRICE=$ETH_PRICE" >> $GITHUB_ENV
          echo "DOGE_PRICE=$DOGE_PRICE" >> $GITHUB_ENV

      - name: Generate Home Page
        run: |
          HOME_FILE="index.html"

          echo '<!DOCTYPE html>
          <html lang="en">
          <head>
              <meta charset="UTF-8">
              <meta name="viewport" content="width=device-width, initial-scale=1.0">
              <meta name="description" content="MiniTV - Your daily source for news, crypto, and stock market updates. Stay updated with the latest trends.">
              <meta name="keywords" content="news, world news, crypto prices, stock market, latest updates">
              <meta name="author" content="MiniTV">
              <meta property="og:title" content="MiniTV - Daily News and Updates">
              <meta property="og:description" content="Get the latest news, cryptocurrency prices, and stock market updates on MiniTV.">
              <meta name="robots" content="index, follow">
              <title>MiniTV - Latest News, Crypto & Stocks</title>
              <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css">

              <!-- Google Analytics -->
              <script async src="https://www.googletagmanager.com/gtag/js?id=G-9MSBCXJPYV"></script>
              <script>
                window.dataLayer = window.dataLayer || [];
                function gtag(){dataLayer.push(arguments);}
                gtag("js", new Date());
                gtag("config", "G-9MSBCXJPYV");
              </script>

              <!-- Google AdSense -->
              <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-1068871795581451" crossorigin="anonymous"></script>

          </head>
          <body>
              <div class="container">
                  <h1>üöÄ Welcome to MiniTV!</h1>
                  <p>Your daily source for News, Crypto, and Stock Updates.</p>

                  <h2>üì¢ Latest Daily News</h2>
                  <ul id="latest-news">' > $HOME_FILE

          # Fetch Latest Posts from `sitemap.xml`
          echo '<script>
                fetch("sitemap.xml")
                .then(response => response.text())
                .then(data => {
                    let parser = new DOMParser();
                    let xml = parser.parseFromString(data, "text/xml");
                    let urls = xml.getElementsByTagName("loc");
                    let ul = document.getElementById("latest-news");
                    for (let i = 1; i < urls.length && i < 6; i++) { // Show last 5 news updates
                        let li = document.createElement("li");
                        let a = document.createElement("a");
                        a.href = urls[i].textContent;
                        a.textContent = urls[i].textContent.split("/").pop().replace(".html", "").replace("-", " ");
                        li.appendChild(a);
                        ul.appendChild(li);
                    }
                });
                </script>' >> $HOME_FILE

          echo '</ul>
                  <h2>üìä Stock Market Updates</h2>
                  <p>üî¥ NASDAQ: '"$NASDAQ"' | üîµ S&P 500: '"$SP500"' | üü¢ Dow Jones: '"$DOWJONES"'</p>

                  <h2>üí∞ Cryptocurrency Prices</h2>
                  <p>üî• Bitcoin: $'"$BTC_PRICE"' | üöÄ Ethereum: $'"$ETH_PRICE"' | üåê Dogecoin: $'"$DOGE_PRICE"'</p>

                  <div class="ads-container">
                      <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
                      <ins class="adsbygoogle"
                          style="display:block"
                          data-ad-client="ca-pub-1068871795581451"
                          data-ad-slot="YOUR_ADSENSE_AD_SLOT"
                          data-ad-format="auto"
                          data-full-width-responsive="true"></ins>
                      <script>
                          (adsbygoogle = window.adsbygoogle || []).push({});
                      </script>
                  </div>

              </div>
          </body>
          </html>' >> $HOME_FILE

      - name: Commit and Push Changes
        run: |
          git config --global user.name "github-actions"
          git config --global user.email "github-actions@github.com"
          git add index.html
          git commit -m "Updated homepage with latest news, stocks, and crypto for $(date +"%Y-%m-%d")" || echo "No changes to commit"
          git push https://x-access-token:${{ secrets.GITHUB_TOKEN }}@github.com/sumitc91/minitv.git main || echo "No changes to push"
